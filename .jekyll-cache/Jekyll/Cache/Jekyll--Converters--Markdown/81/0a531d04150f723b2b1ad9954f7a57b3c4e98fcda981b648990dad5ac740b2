I"QE<p>On Thursday 19th Feb I attended my first meetup event from the <a href="https://www.meetup.com/Python-North-West-Meetup/">Python North West User group</a>. The material of this session was focussed on SQL and featured a presentation and live demo of how SQL can be used with Python, delivered by <a href="https://github.com/waveform80/">Dave Jones</a>. This was particularly good as you got hands-on with the code, with Dave leading the way to ensure everything worked. Here I have written a brief write up of the main points from the meetup and some of the SQL that we went through.</p>

<h4 id="so-what-is-sql">So what is SQL?</h4>

<p><a href="https://en.wikipedia.org/wiki/SQL">SQL</a>, which stands for Structured Query Language, has been around a long time and has been an ISO standard since the 1980’s. It is a language which is used for managing data in relational databases and is very widely used - such as to run everyone’s bank accounts. Practically speaking, as it is old the standard is not followed universally and there are a number of different ways of running SQL. Furthermore, there have been a number of attempts to replace it, however it is still the de-facto standard.</p>

<h4 id="using-sql-with-python">Using SQL with Python</h4>

<p>In Python, there are many different libraries for interfacing with SQL, but they can be badly designed and too variable/low-level to be useful. Dave recommended the libraries SQLAlchemy and Pandas to do the bulk of the work. Once you have them installed you can load up a terminal window and enter the following to create a new SQL engine using SQLAlchemy.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="n">sa</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sa</span><span class="p">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite:///newdatabase.db'</span><span class="p">)</span></code></pre></figure>

<p>Then you can connect to it with</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">c</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span></code></pre></figure>

<p>Now you are ready to start creating the powerful relational databases which are possible with SQL. This makes use of the engine <a href="https://www.sqlite.org/index.html">SQLite</a>, which comes bundled in Python. To speak to the engine you then write your SQL commands into a string and pass them into the engine for execution.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sql</span> <span class="o">=</span> <span class="s">""" SQL commands here """</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></code></pre></figure>

<h4 id="creating-a-table">Creating a table</h4>

<p>In the session, Dave used the example of a flight data recording system. First things first you will want to create a table to store the data. The SQL command that you would pass is as follows.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">readings</span> <span class="p">(</span>
    <span class="n">flight</span>    <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">ts</span>        <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">temp</span>      <span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">pressure</span>  <span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">humidity</span>  <span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">accel_x</span>   <span class="nb">REAL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">accel_y</span>   <span class="nb">REAL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">accel_z</span>   <span class="nb">REAL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">readings_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">flight</span><span class="p">,</span> <span class="n">ts</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">temp_ck</span> <span class="k">CHECK</span> <span class="p">(</span><span class="k">temp</span> <span class="k">BETWEEN</span> <span class="o">-</span><span class="mi">70</span> <span class="k">AND</span> <span class="mi">70</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">pres_ck</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">pressure</span> <span class="k">BETWEEN</span> <span class="mi">0</span> <span class="k">AND</span> <span class="mi">2000</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">hum_ck</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">humidity</span> <span class="k">BETWEEN</span> <span class="mi">0</span> <span class="k">AND</span> <span class="mi">100</span><span class="p">)</span></code></pre></figure>

<p>Here we have created a table called “readings”, with multiple columns titled “fight”, “ts”, “temp”, etc. For each column we specify a data-type, e.g. TIMESTAMP must be a time/date, and NUMERIC, is a number. You can read more about data types <a href="https://www.w3schools.com/sql/sql_datatypes.asp">here</a>. We also specify that each column cannot contain a NULL value, this is good practice and ensures that data must be entered into each column to create a new row. Finally, and perhaps most importantly, we can apply constraints to the data.</p>

<p>Firstly, we must specify a PRIMARY KEY, which is a unique identifier for each row in the table. This is very important as the order of rows in the table is not fixed and SQL can move them around a bit, therefore a key for each row is necessary. In our case, the key for each row is a combination of the flight and ts columns - i.e. each row must have a unique combination of timestamp and flight number. So a single flight cannot record twice on the same timestamp, which makes sense.</p>

<p>Next, we constrain some of the data, specifically the temperature, pressure and humidity measurements to ensure they are physical.</p>

<p>So to actually run this command in the terminal we simply paste the SQL into a string and then pass that to SQLAlchemy.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sql</span> <span class="o">=</span> <span class="s">""" 
CREATE TABLE readings (
    flight    VARCHAR(10) NOT NULL,
    ts        TIMESTAMP NOT NULL,
    temp      NUMERIC(3,1) NOT NULL,
    pressure  NUMERIC(4,0) NOT NULL,
    humidity  NUMERIC(3,0) NOT NULL,
    accel_x   REAL DEFAULT 0 NOT NULL,
    accel_y   REAL DEFAULT 0 NOT NULL,
    accel_z   REAL DEFAULT 0 NOT NULL,
    CONSTRAINT readings_pk PRIMARY KEY (flight, ts),
    CONSTRAINT temp_ck CHECK (temp BETWEEN -70 AND 70),
    CONSTRAINT pres_ck CHECK (pressure BETWEEN 0 AND 2000),
    CONSTRAINT hum_ck CHECK (humidity BETWEEN 0 AND 100)
"""</span>
<span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></code></pre></figure>

<h4 id="inserting-data">Inserting data</h4>

<p>We can insert data into this table using the following SQL commands.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">readings</span><span class="p">(</span><span class="n">flight</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="k">temp</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">humidity</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'hab1'</span><span class="p">,</span> <span class="s1">'2015-01-01 09:00:00'</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1020</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>

<span class="c1">-- Inserting multiple rows in a single statement</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">readings</span><span class="p">(</span><span class="n">flight</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="k">temp</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">humidity</span><span class="p">)</span>
<span class="k">VALUES</span>
  <span class="p">(</span><span class="s1">'hab1'</span><span class="p">,</span> <span class="s1">'2015-01-01 09:01:00'</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1019</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
  <span class="p">(</span><span class="s1">'hab1'</span><span class="p">,</span> <span class="s1">'2015-01-01 09:02:00'</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1019</span><span class="p">,</span> <span class="mi">41</span><span class="p">);</span>

<span class="c1">-- Inserting the results of a query</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">readings</span>
<span class="k">SELECT</span> <span class="n">flight</span><span class="p">,</span> <span class="nb">DATETIME</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="s1">'+3 minutes'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ts</span><span class="p">,</span> <span class="k">temp</span><span class="p">,</span>
       <span class="n">pressure</span><span class="p">,</span> <span class="n">humidity</span><span class="p">,</span> <span class="n">accel_x</span><span class="p">,</span> <span class="n">accel_y</span><span class="p">,</span> <span class="n">accel_z</span>
<span class="k">FROM</span> <span class="n">readings</span><span class="p">;</span></code></pre></figure>

<p>In the final line, we query the table and then insert new lines which are shifted along in time by 3 minutes.</p>

<h4 id="viewing-the-data">Viewing the data</h4>

<p>To view the data we can use Pandas (we change the display options so that it fits on the page better).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pd</span><span class="p">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.width'</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">'readings'</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></code></pre></figure>

<p>If you have inserted all the lines into the table by running the SQL commands detailed above then you should see a six-line table as the result.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">      flight                  ts  temp  pressure  humidity  accel_x  accel_y  accel_z
0   hab1 2015-01-01 09:00:00  25.5      1020        40        0        0        0
1   hab1 2015-01-01 09:01:00  25.5      1019        40        0        0        0
2   hab1 2015-01-01 09:02:00  25.5      1019        41        0        0        0
3   hab1 2015-01-01 09:03:00  25.5      1020        40        0        0        0
4   hab1 2015-01-01 09:04:00  25.5      1019        40        0        0        0
5   hab1 2015-01-01 09:05:00  25.5      1019        41        0        0        0</code></pre></figure>

<h4 id="working-with-a-lot-of-data">Working with a lot of data</h4>

<p>Every time we run the execute command we make a transaction with the database and all the changes are immediately written to the database file. This makes transactions computationally expensive and therefore when working with a lot of data it is best to group data together and perform them in one transaction. If you have a dataset that is in a .csv file then a quick way to import it all into the table is as follows.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">insert</span> <span class="o">=</span> <span class="s">"""
        INSERT INTO readings
            (flight, ts, temp, pressure, humidity,
            accel_x, accel_y, accel_z)
        VALUES
            ('hab1', ?, ?, ?, ?, ?, ?, ?)
    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">temp_h</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">pressure</span><span class="p">,</span>
         <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">humidity</span><span class="p">)),</span>
         <span class="n">row</span><span class="p">.</span><span class="n">accel_x</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">accel_y</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">accel_z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">itertuples</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="k">with</span> <span class="n">c</span><span class="p">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"DELETE FROM readings"</span><span class="p">)</span>
        <span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code></pre></figure>

<p>You can also see the <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.to_sql.html">to_sql()</a> method in Pandas. You have to be careful when inserting large amounts of data to ensure you do not leave yourself vulnerable to <a href="https://www.w3schools.com/sql/sql_injection.asp">SQL injection</a>.</p>

<h4 id="saving-the-data">Saving the data</h4>

<p>One query I had during the meetup was how to save the data. Well, as I mentioned before, each transaction with the database saves everything to hard disk. Therefore, you should see a ‘newdatabase.db’ file in the directory you have been working in. Dave reassured us that these files are hard to corrupt or damage, which is handy given all the important data companies store in them.</p>

<p>I hope that this post has helped some of you appreciate how easily you can get a database set up in SQL. I am looking to getting some more hands-on experience of it in the future. If you have any comments or corrections to this post then please <a href="mailto:henryfcox@live.com">let me know</a>.</p>

<p>Photo: Taken on Air New Zealand flight NZ001 over Washington, USA.</p>

:ET